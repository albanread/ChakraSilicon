# ChakraBlue Project Status

**Last Updated:** 2024 (Current Session)

**Project:** ChakraCore with Apple Silicon ARM64 JIT support

---

## Current Status: READY FOR X64 ANALYSIS

We have successfully set up the tools and environment needed to understand and fix the ARM64 JIT issues by analyzing the working x64 implementation.

---

## What Works ‚úÖ

### Build System
- ‚úÖ All build targets compile successfully
  - `chintx64` - x64 interpreter-only
  - `chjitx64` - x64 JIT (working under Rosetta)
  - `chinta64` - ARM64 interpreter-only
  - `chjita64` - ARM64 JIT (broken)
- ‚úÖ Build scripts updated and tested
- ‚úÖ Capstone disassembly integration (x64 and ARM64)

### x64 Mac Build (Under Rosetta)
- ‚úÖ Compiles cleanly
- ‚úÖ All tests pass
- ‚úÖ JIT‚ÜíINT calls work perfectly
- ‚úÖ Can be debugged with LLDB
- **Location:** `./dist/chjitx64/ch`

### Documentation
- ‚úÖ Complete research documentation in `examination/`
- ‚úÖ Critical unknowns cataloged
- ‚úÖ Debugging tools prepared
- ‚úÖ Test suite ready

### Repository
- ‚úÖ Converted from submodules to flat structure
- ‚úÖ All ChakraCore source tracked
- ‚úÖ Organized structure (scripts, docs, examination, etc.)
- ‚úÖ Version control and history preserved

---

## What's Broken ‚ùå

### ARM64 Mac JIT (Native Apple Silicon)
- ‚ùå JIT‚ÜíINT calls hang infinitely
- ‚ùå Cannot call interpreter-mode built-in functions from JIT code
- ‚ùå Cross-function exception handling fails
- **Location:** `./dist/chjita64/ch`

### Specific Failure Mode
```javascript
// This hangs on ARM64 (works on x64):
function test() {
    return Math.max(42, 17);  // JIT code calling built-in
}
for (var i = 0; i < 10000; i++) test(); // Force JIT compilation
test(); // HANGS HERE on ARM64
```

---

## Root Cause (Hypothesis)

The static interpreter thunk generated by `InterpreterThunkEmitter.cpp` for ARM64 does not correctly set up the stack frame and parameters expected by:
1. The dynamic interpreter thunk
2. The ARGUMENTS macro
3. The interpreter helper functions

**File to fix:** `ChakraCore/lib/Runtime/Language/InterpreterThunkEmitter.cpp`

---

## Investigation Strategy

### Phase 1: Learn from x64 (NEXT STEP - START HERE)

**Goal:** Understand how the working x64 implementation handles JIT‚ÜíINT transitions

**Tools Ready:**
- Test suite: `examination/test_jit_to_int.js`
- LLDB script: `examination/debug_x64_thunk.lldb`
- Debug guide: `examination/X64_DEBUGGING_GUIDE.md`
- Quick start: `examination/QUICK_START.md`

**Action Items:**
1. Run x64 under LLDB
2. Set breakpoint at `InterpreterStackFrame::InterpreterHelper`
3. Capture register state, stack layout, and disassembly
4. Document findings in `examination/X64_FINDINGS.md`

**Questions to Answer:**
- What values are in rdi, rsi, rdx, rcx, r8, r9 at thunk entry?
- What is the stack frame layout?
- How much stack space is allocated?
- Where are parameters stored?
- What does the ARGUMENTS macro expect to find?
- What does the dynamic thunk do?

**Time Estimate:** 2-4 hours

### Phase 2: Compare with ARM64 Source

**Goal:** Identify specific differences in ARM64 implementation

**Action Items:**
1. Read x64 thunk code in `InterpreterThunkEmitter.cpp`
2. Read ARM64 thunk code in same file
3. Compare with x64 runtime behavior observed in Phase 1
4. Identify mismatches and bugs

**Time Estimate:** 1-2 hours

### Phase 3: Fix ARM64 Thunk

**Goal:** Make ARM64 thunk match the correct behavior observed in x64

**Action Items:**
1. Modify ARM64 thunk generation code
2. Rebuild: `./scripts/build_target.sh chjita64`
3. Test: `./dist/chjita64/ch examination/test_jit_to_int.js`
4. Debug if still broken (add logging, iterate)
5. Run full test suite when working

**Time Estimate:** 2-8 hours (depending on complexity)

### Phase 4: Fix Exception Unwinding

**Goal:** Fix cross-function exception handling (separate issue)

**See:** `examination/next_steps.md` for complete plan

**Time Estimate:** 1-2 weeks

---

## Quick Start Commands

### Verify x64 Works
```bash
./dist/chjitx64/ch examination/test_jit_to_int.js
# Expected: All 10 tests PASS
```

### Debug x64 (Automated)
```bash
lldb ./dist/chjitx64/ch
(lldb) command source examination/debug_x64_thunk.lldb
(lldb) run examination/test_jit_to_int.js
# Follow prompts, capture state when breakpoint hits
```

### Test ARM64 (Will Hang)
```bash
timeout 10s ./dist/chjita64/ch examination/test_jit_to_int.js || echo "Timed out as expected"
```

### Rebuild After Changes
```bash
./scripts/build_target.sh chjita64
```

---

## Key Files

### To Fix
- `ChakraCore/lib/Runtime/Language/InterpreterThunkEmitter.cpp` - **THE PRIMARY TARGET**
- `ChakraCore/lib/Runtime/Language/Arguments.h` - ARGUMENTS macro (may need adjustment)

### To Study
- `ChakraCore/lib/Runtime/Language/InterpreterStackFrame.cpp` - Interpreter helper
- `ChakraCore/lib/Runtime/Language/InterpreterStackFrame.h` - Stack structures
- `ChakraCore/lib/Backend/ARM64/LowerMD.cpp` - ARM64 JIT code generation

### Documentation
- `examination/QUICK_START.md` - **START HERE**
- `examination/critical_unknowns.md` - What we need to understand
- `examination/X64_DEBUGGING_GUIDE.md` - Complete debugging walkthrough
- `examination/next_steps.md` - Overall ARM64 investigation plan

### Test & Tools
- `examination/test_jit_to_int.js` - Test suite
- `examination/debug_x64_thunk.lldb` - Automated debugging script

---

## Critical Unknowns (From Research)

See `examination/critical_unknowns.md` for complete details.

### üî¥ P0 - Blocking
1. What is the dynamic interpreter thunk and where is it?
2. Why did the Windows-style fix fail?
3. What is the ARM64 Darwin calling convention for varargs?

### üü° P1 - Important
4. How does the ARGUMENTS macro compute parameter addresses?
5. What is the complete JIT‚ÜíINT call chain?
6. Is exception unwinding related to this issue?

**These will be answered by Phase 1 analysis.**

---

## Success Criteria

### Minimum Viable Product
- ‚úÖ x64 build working (DONE)
- ‚è≥ ARM64 JIT‚ÜíINT calls working (IN PROGRESS)
- ‚è≥ Test suite passing on ARM64
- ‚è≥ No infinite hangs

### Full Success
- ‚è≥ ARM64 JIT‚ÜíINT calls working
- ‚è≥ Cross-function exception handling working
- ‚è≥ All ChakraCore tests passing
- ‚è≥ Performance acceptable

### Production Ready
- ‚è≥ Stability verified
- ‚è≥ Memory leaks addressed
- ‚è≥ Documentation complete
- ‚è≥ CI/CD pipeline

**Current Progress:** ~15% (build system and research complete, implementation pending)

---

## Timeline Estimate

| Task | Time | Status |
|------|------|--------|
| Repository setup | 2-4 hours | ‚úÖ DONE |
| Build system | 2-4 hours | ‚úÖ DONE |
| Research & documentation | 4-8 hours | ‚úÖ DONE |
| **x64 analysis** | **2-4 hours** | **‚è≥ NEXT** |
| ARM64 thunk fix | 2-8 hours | ‚è≥ TODO |
| Testing & iteration | 2-8 hours | ‚è≥ TODO |
| Exception unwinding fix | 40-80 hours | ‚è≥ TODO |
| Full testing & polish | 8-16 hours | ‚è≥ TODO |
| **Total** | **62-132 hours** | **~15% complete** |

---

## Rosetta Setup

Rosetta 2 is **already installed** on your system.

- Verified: `pgrep -q oahd` returns success
- x64 binaries run automatically under Rosetta
- Can force x64 mode: `arch -x86_64 <command>`

No action needed - ready to use!

---

## Next Actions (In Order)

1. **Read** `examination/QUICK_START.md`
2. **Run** `./dist/chjitx64/ch examination/test_jit_to_int.js` (verify it works)
3. **Start debugging:** `lldb ./dist/chjitx64/ch`
4. **Load script:** `(lldb) command source examination/debug_x64_thunk.lldb`
5. **Run:** `(lldb) run examination/test_jit_to_int.js`
6. **Document findings** in `examination/X64_FINDINGS.md`
7. **Compare** with ARM64 source code
8. **Implement fix** in `InterpreterThunkEmitter.cpp`
9. **Test** on ARM64
10. **Iterate** until working

---

## Resources

### Internal Documentation
- This file: High-level status
- `examination/QUICK_START.md`: Fast-track guide
- `examination/critical_unknowns.md`: Research questions
- `examination/X64_DEBUGGING_GUIDE.md`: Detailed debugging steps
- `examination/next_steps.md`: Complete ARM64 plan

### External References
- ARM AAPCS64: ARM Architecture Procedure Call Standard
- System V AMD64 ABI: x64 calling convention
- Apple ARM64 ABI: Darwin-specific extensions
- LLDB documentation: https://lldb.llvm.org/

### ChakraCore
- GitHub: https://github.com/chakra-core/ChakraCore (upstream, archived)
- This is a fork with Apple Silicon work in progress

---

## Methodology

**Old approach (failed):**
- Try random fixes
- Copy from other platforms
- Hope something works

**New approach (current):**
1. Understand the working implementation (x64)
2. Compare with broken implementation (ARM64)
3. Identify root cause
4. Design correct fix
5. Implement with confidence
6. Test thoroughly

**Result:** Higher success rate, less wasted time

---

## Contact / Notes

This is a work-in-progress fork of ChakraCore focused on enabling Apple Silicon support.

**Primary blocker:** JIT‚ÜíINT call transition on ARM64

**Next milestone:** Complete x64 analysis and fix ARM64 thunk

**Estimated completion of Phase 1-3:** 5-14 hours of focused work

---

**Status:** Ready to proceed with x64 analysis. All tools prepared. üöÄ